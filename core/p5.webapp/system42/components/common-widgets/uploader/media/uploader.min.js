(function(){p5.uploader=function(n,t,i,r,u,f,e,o){this._widget=p5.$(n);this._cssClass=t;this._hoverClass=i;this._dropClass=r;this._errorClass=u;this._filter=f==""?[]:f.split("|");this._multiple=e;this._file=p5.$(o).el;var s=this;this._widget.el.addEventListener("click",function(){s._file.click()},!1);this._file.addEventListener("click",function(n){n.stopPropagation()});this._file.addEventListener("change",function(n){if(s.checkFile(n)){if(s._file.files.length>0){s.addPreview(s._file.files);s._widget.el.className=s._cssClass+" "+s._dropClass;s._files=[];for(var t=0;t<s._file.files.length;t++)s._files.push(s._file.files[t]);s._count=s._files.length;s.processNext(0)}}else s._widget.el.className=s._cssClass+" "+s._errorClass;s._file.value=null});this._widget.el.addEventListener("dragover",function(n){n.preventDefault();s._widget.el.className=s._cssClass+" "+s._hoverClass},!1);this._widget.el.addEventListener("dragleave",function(n){n.preventDefault();s._widget.el.className=s._cssClass},!1);this._widget.el.addEventListener("drop",function(n){if(n.preventDefault(),s.checkFile(n)){if(n.dataTransfer.files.length>0){s.addPreview(n.dataTransfer.files);s._widget.el.className=s._cssClass+" "+s._dropClass;s._files=[];for(var t=0;t<n.dataTransfer.files.length;t++)s._files.push(n.dataTransfer.files[t]);s._count=s._files.length;s.processNext(0)}}else s._widget.el.className=s._cssClass+" "+s._errorClass},!1)};p5.uploader.prototype.checkFile=function(n){var t,i;if(this._filter.length==0)return!0;if(this._multiple===!1&&(n.dataTransfer.files||n.files).length>1)return!1;for(t=0;t<(n.dataTransfer.files||n.files).length;t++){var r=(n.dataTransfer.files||n.files)[t].name.split("."),f=r[r.length-1],u=!1;for(i=0;i<this._filter.length;i++)if(this._filter[i]==f){u=!0;break}if(!u)return!1}return!0};p5.uploader.prototype.addPreview=function(n){for(var f,t=0;t<n.length;t++){var u=n[t].name.split("."),r=u[u.length-1],i=document.createElement("img");r=="jpg"||r=="jpeg"||r=="gif"||r=="png"?(f=URL.createObjectURL(n[t]),i.src=f):i.src="/system42/components/common-widgets/uploader/media/preview.png";i.alt=n[t].name;i.title=n[t].name;this._widget.el.appendChild(i)}};p5.uploader.prototype.processNext=function(n){var i=this._files.splice(0,1)[0],r=new FileReader,t=this;r.onload=function(r){t._widget.raise(".onupload",{onsuccess:function(){for(var i=0;i<t._widget.el.childNodes.length;i++)if(t._widget.el.childNodes[i].tagName=="IMG"){t._widget.el.removeChild(t._widget.el.children[i]);break}t._files.length>0?t.processNext(++n):t._widget.el.className=t._cssClass},onbefore:function(u){u.push(["sys42.widgets.uploader.count",t._count]);u.push(["sys42.widgets.uploader.current",n]);u.push(["sys42.widgets.uploader.filename",i.name]);u.push(["sys42.widgets.uploader.content",btoa(r.target.result)])}})};r.readAsBinaryString(i)}})();