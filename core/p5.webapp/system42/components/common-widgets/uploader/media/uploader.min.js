(function(){p5.uploader=function(n,t,i,r,u,f,e,o){this._widget=p5.$(n);this._cssClass=t;this._hoverClass=i;this._dropClass=r;this._errorClass=u;this._filter=f==""?[]:f.split("|");this._multiple=e;this._file=p5.$(o).el;var s=this;this._widget.el.addEventListener("click",function(){s._file.click()},!1);this._file.addEventListener("click",function(n){n.stopPropagation()});this._file.addEventListener("change",function(){s.onFileInputChanged()});this._widget.el.addEventListener("drop",function(n){s.onDrop(n)},!1);this._widget.el.addEventListener("dragover",function(n){s.onDragOver(n)},!1);this._widget.el.addEventListener("dragleave",function(n){s.onDragLeave(n)},!1)};p5.uploader.prototype.onFileInputChanged=function(){this.uploadFiles(this._file.files);this._file.value=null};p5.uploader.prototype.onDrop=function(n){n.preventDefault();this.uploadFiles(n.dataTransfer.files)};p5.uploader.prototype.uploadFiles=function(n){if(this.checkFile(n)){if(n.length>0){this.addPreview(n);this._widget.el.className=this._cssClass+" "+this._dropClass;this._files=[];for(var t=0;t<n.length;t++)this._files.push(n[t]);this._count=this._files.length;this.processNext(0)}}else this._widget.el.className=this._cssClass+" "+this._errorClass,setTimeout(function(){this._widget.el.className=this._cssClass},1e3)};p5.uploader.prototype.onDragLeave=function(n){n.preventDefault();this._widget.el.className=this._cssClass};p5.uploader.prototype.onDragOver=function(n){n.preventDefault();this._widget.el.className=this._cssClass+" "+this._hoverClass};p5.uploader.prototype.checkFile=function(n){var t,i;if(this._filter.length==0)return!0;if(this._multiple===!1&&n.length>1)return!1;for(t=0;t<n.length;t++){var r=n[t].name.split("."),f=r[r.length-1],u=!1;for(i=0;i<this._filter.length;i++)if(this._filter[i]==f){u=!0;break}if(!u)return!1}return!0};p5.uploader.prototype.addPreview=function(n){for(var f,t=0;t<n.length;t++){var i=document.createElement("img"),u=n[t].name.split("."),r=u[u.length-1];u.length>1&&(r=="jpg"||r=="jpeg"||r=="gif"||r=="png")?(f=URL.createObjectURL(n[t]),i.src=f):i.src="/system42/components/common-widgets/uploader/media/preview.png";i.alt=n[t].name;i.title=n[t].name;this._widget.el.appendChild(i)}};p5.uploader.prototype.processNext=function(n){var i=this._files.splice(0,1)[0],r=new FileReader,t=this;r.onload=function(r){t._widget.raise(".onupload",{onbefore:function(u){u.push(["sys42.widgets.uploader.count",t._count]);u.push(["sys42.widgets.uploader.current",n]);u.push(["sys42.widgets.uploader.filename",i.name]);u.push(["sys42.widgets.uploader.content",btoa(r.target.result)])},onsuccess:function(){for(var u,i=t._widget.el,r=0;r<i.childNodes.length;r++)if(u=i.childNodes[r],u.tagName=="IMG"){i.removeChild(u);break}t._files.length>0?t.processNext(++n):i.className=t._cssClass}})};r.readAsBinaryString(i)}})();